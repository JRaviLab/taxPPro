---
title: "Example of upstream and downstream with aerophilicity and ph"
output: 
    html_document:
        toc: true
date: "2022-08-18"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE
)
```

```{r setup}
library(taxPPro)
library(bugphyzz)
library(dplyr)
library(purrr)
library(tidyr)
library(ggplot2)
```

# Attribute with discrete characters

```{r}
aer <- as_tibble(physiologies('aerophilicity')[[1]])
dim(aer)
```


```{r, message=TRUE}
aer_extended <- propagate(aer)
```


```{r}
table(aer$Evidence)
```


```{r}
table(aer_extended$Evidence)
```


# Attribute with continuous characters

```{r}
ph <- as_tibble(physiologies('optimal ph')[[1]])
```

```{r, message=TRUE}
ph_extended <- propagate(ph)
```


```{r}
table(ph$Evidence)
```

```{r}
table(ph_extended$Evidence)
```

# Completeness

```{r}
ncbi_taxonomy <- get_ncbi_taxonomy() |> 
    mutate(strain = ifelse(rank == 'strain', tax_name, NA))
## mutate call above is just for creating a strain column
## for counts

dim(ncbi_taxonomy)
```

```{r}
head(ncbi_taxonomy)
```

## Get counts

```{r}
ranks <- c(
    'strain', 'species', 'genus', 'family', 'order', 'class', 'phyum', 'kingdom'
)

ncbi_counts <- ncbi_taxonomy |> 
    dplyr::filter(rank %in% ranks) |> 
    count(rank) |> 
    set_names(c('Rank', 'n_ncbi'))

ncbi_counts |> 
    mutate(Rank = factor(Rank, levels = ranks)) |> 
    ggplot(aes(reorder(Rank, n_ncbi), n_ncbi)) +
    geom_col() +
    geom_label(aes(label = n_ncbi)) +
    labs(
        title = 'NCBI totals',
        x = 'rank'
    )
    
```


```{r}
aer_counts <- aer |> 
    count(Rank) |> 
    set_names(c('Rank', 'n_aer')) |> 
    filter(Rank %in% c('genus', 'species', 'strain'))
aer_counts
```

```{r}
aer_extended_counts <- aer_extended |> 
    count(Rank) |> 
    set_names(c('Rank', 'n_aer_extended')) |> 
    filter(Rank %in% c('genus', 'species', 'strain'))
aer_extended_counts 
```


```{r}
extended_data <- list(aer = aer_counts, aer_extended = aer_extended_counts) |> 
    bind_rows(.id = 'type') |> 
    tidyr::unite(n_aer, n_aer_extended, col = 'n') |> 
    mutate(n = sub('_NA', '', n)) |> 
    mutate(n = as.integer(sub('NA_', '', n)))
```

```{r}
extended_data |> 
    ggplot(aes(Rank, n)) + 
    geom_col(aes(fill = type), position = 'dodge') +
    labs(title = 'Numbers in aerophilicity before and after propagation.') +
    theme_bw() +
    theme(
        panel.grid.major.x = element_blank()
    ) +
    scale_fill_manual(
        values = c('dodgerblue3', 'firebrick3'),
        labels = c('Before propagation', 'After propagation')
    )
```


# Calculate completeness

```{r,message=FALSE}
completeness <- reduce(
    list(ncbi_counts, aer_counts, aer_extended_counts),
    .f = left_join
    ) |> 
    mutate(
        aer_completness = n_aer / n_ncbi * 100,
        aer_extended_completeness = n_aer_extended / n_ncbi * 100
    ) |> 
    filter(Rank %in% c('strain', 'species', 'genus')) |> 
    select(Rank, aer_completness, aer_extended_completeness) |> 
    pivot_longer(
        cols = 2:last_col(), names_to = 'type', values_to = 'completeness'
    )
completeness
```

# Plot completeness

```{r}
completeness |> 
    ggplot(aes(Rank, completeness)) + 
    geom_col(aes(fill = type), position = 'dodge') +
    labs(
        title = "Completness aerophilicity",
        subtitle = 'Number in bugphyz / number in NCBI per rank',
        y = 'Completeness (%)'
    ) +
    theme_bw() +
    theme(
        panel.grid.major.x = element_blank()
    ) +
    scale_fill_manual(
        values = c('dodgerblue3', 'firebrick3'),
        labels = c('Before propagation', 'After propagation')
    )
```


>NOTE: The completness at the species level is much lower than the rest
because there are several bacterial species annotated in the NCBI that
are unclassiifed (over 400, 000). See this stats withouht cheking any box and 
clicking the update button: https://www.ncbi.nlm.nih.gov/Taxonomy/taxonomyhome.html/index.cgi?chapter=statistics&period=&from=&to=


# Case 1 - Actinobacillus

This needs more work

Input: 

```{r}
aer |> 
    filter(Parent_name == 'Actinobacillus' | Taxon_name == 'Actinobacillus') |> 
    DT::datatable(filter = 'top', options = list(scrollX = T))
```


Output:

```{r}
aer_extended |> 
    filter(Parent_name == 'Actinobacillus' | Taxon_name == 'Actinobacillus') |> 
    DT::datatable(filter = 'top', options = list(scrollX = T))
```



# Case 2 - Actinomyces

Input: 

```{r}
aer |> 
    filter(grepl('Actinomyces', Taxon_name) | Parent_name == 'Actinomyces') |> 
    DT::datatable(filter = 'top', options = list(scrollX = T))
```
Output:

```{r}
aer_extended |> 
    filter(grepl('Actinomyces', Taxon_name) | Parent_name == 'Actinomyces') |> 
    DT::datatable(filter = 'top', options = list(scrollX = T))
```

