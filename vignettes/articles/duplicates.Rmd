---
title: "Duplicates and conflicting annotations in bugphyzz"
output:
    html_document:
        toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE
)
```

```{r setup, message=FALSE}
library(taxPPro)
library(bugphyzz)
library(dplyr)
library(purrr)
library(ggplot2)
```


# Definitions of different types of duplicates

+ **Duplicates**. Taxa annotated more than once in a single spreadsheet. The
types of duplicates are: double annotations, agreements, conflicts.
+ **Double annotations**. Taxa with two or more annotations from a single
attribute source.
+ **Agreements**. Taxa with the same annotation from two or more attribute
sources.
+ **Conflicts**. Taxa with two or more annotations from different attribute
sources.

# Import data from bugphyzz

```{r, message=FALSE}
phys <- map(physiologies(), as_tibble)
subtitle_msg <- 
    'In the case of character/logical values, only TRUE values are included'
```

# Get duplicates

```{r, message=FALSE}
## Define a function to get the different types of duplicates
get_dups <- function(df) {
    double_annotations <- get_double_annotations(df)
    agreements <- get_agreements(df)
    conflicts <- get_conflicts(df)
    all_dups <- list(
        double_annotation = double_annotations,
        agreement = agreements,
        conflict = conflicts
    ) |>
        dplyr::bind_rows(.id = 'Duplicate_type')
    if (!nrow(all_dups)) {
        return(NULL)
    } else {
        return(all_dups)
    }
}

dups <- map(phys, ~ {
    df <- get_dups(.x)
    df$Genome_ID <- as.character(df$Genome_ID)
    df
}) |> 
    discard(is.null) |> 
    bind_rows(.id = 'dataset')
```

# Individual examples

## Example of double annotation

```{r}
taxa_double_annotation <- dups |> 
    filter(Duplicate_type == 'double_annotation') |> 
    pull(Taxon_name) |> 
    unique()

dups |> 
    filter(
        Taxon_name == taxa_double_annotation[1],
        Duplicate_type == 'double_annotation'
    ) |> 
    knitr::kable()
```

## Example of agreement

```{r}
taxa_agreements <- dups |> 
    filter(Duplicate_type == 'agreement') |> 
    pull(Taxon_name) |> 
    unique()

dups |> 
    filter(Taxon_name == taxa_agreements[1], Duplicate_type == 'agreement') |> 
    knitr::kable()
```

## Example of conflict

```{r}
taxa_conflicts <- dups |> 
    filter(Duplicate_type == 'conflict') |> 
    pull(Taxon_name) |> 
    unique()

dups |> 
    filter(Taxon_name == taxa_conflicts[1], Duplicate_type == 'conflict') |> 
    knitr::kable()
```





# Plot number of rows with diffrent types of duplicates

```{r}
dups_row_counts <- dups |> 
    count(dataset, Duplicate_type)

dups_row_counts |> 
    ggplot(aes(dataset, n)) + 
    geom_col(aes(fill = Duplicate_type)) +
    labs(
        title = 'Number of rows with different types of duplicates',
        subtitle = subtitle_msg
    ) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    )
```

# Plot proportions of rows with diffferent types of duplicates

```{r}
dups_row_counts |> 
    group_by(dataset) |> 
    mutate(prop = round(prop.table(n) * 100, digits = 2)) |> 
    ungroup() |> 
    ggplot(aes(dataset, prop)) + 
    geom_col(aes(fill = Duplicate_type)) +
    labs(
        title = 'Number of rows with different types of duplicates',
        subtitle = subtitle_msg
    ) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    ) + 
    scale_y_continuous(labels = scales::percent_format())
```

# Plot number of rows with conflicts

```{r}
dups_row_counts |>
    filter(Duplicate_type == 'conflict') |> 
    ggplot(aes(dataset, n)) +
    geom_col() +
    geom_label(aes(label = n)) +
    labs(
        title = 'Number of rows with conflicts per dataset',
        subtitle = subtitle_msg
    ) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    )
```

# Plot number of unique taxa with different types of duplicates

```{r}
dups_taxa_counts <- dups |> 
    select(dataset, Duplicate_type, Taxon_name) |> 
    distinct() |> 
    count(dataset, Duplicate_type)

dups_taxa_counts |> 
    ggplot(aes(dataset, n)) +
    geom_col(aes(fill = Duplicate_type)) +
    labs(
        title = 'Number of unique taxa with dupicates per dataset',
        subtitle = subtitle_msg
    ) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    )
```

# Plot proportions of unique taxa with duplicates per dataset

```{r}
dups_taxa_counts |> 
    group_by(dataset) |> 
    mutate(prop = round(prop.table(n) * 100, digits = 2)) |> 
    ungroup() |> 
    ggplot(aes(dataset, prop)) +
    geom_col(aes(fill = Duplicate_type)) +
    labs(
        title = 'Proportion of unique taxa per duplicate type per dataset',
        subtitle = subtitle_msg
    ) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    )

```

# Plot number of unique taxa with conflicts

```{r}
dups_taxa_counts |> 
    filter(Duplicate_type == 'conflict') |> 
    ggplot(aes(dataset, n)) +
    geom_col() +
    geom_label(aes(label = n)) +
    labs(
        title = 'Number of unique taxa with conflicts per dataset',
        subtitle = subtitle_msg
    ) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    )
```

# Resolved agreements 


# Resolved conflicts


