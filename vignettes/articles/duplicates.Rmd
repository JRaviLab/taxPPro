---
title: "Duplicates and conflicting annotations in bugphyzz"
output:
    html_document:
        toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE
)
```

```{r setup, message=FALSE}
library(taxPPro)
library(bugphyzz)
library(dplyr)
library(purrr)
library(ggplot2)
```


# Definitions of different types of duplicates

+ **Duplicates**. Taxa annotated more than once in a single spreadsheet. The
types of duplicates are: double annotations, agreements, conflicts.
+ **Double annotations**. Taxa with two or more annotations from a single
attribute source.
+ **Agreements**. Taxa with the same annotation from two or more attribute
sources.
+ **Conflicts**. Taxa with two or more annotations from different attribute
sources.

# Import data from bugphyzz

```{r, message=FALSE}
phys <- map(physiologies(), as_tibble)
subtitle_msg <- 
    'In the case of character/logical values, only TRUE values are included'
```

# Get duplicates

```{r, message=FALSE}
## Define a function to get the different types of duplicates
get_dups <- function(df) {
    double_annotations <- get_double_annotations(df)
    agreements <- get_agreements(df)
    conflicts <- get_conflicts(df)
    all_dups <- list(
        double_annotation = double_annotations,
        agreement = agreements,
        conflict = conflicts
    ) |>
        dplyr::bind_rows(.id = 'Duplicate_type')
    if (!nrow(all_dups)) {
        return(NULL)
    } else {
        return(all_dups)
    }
}

dups <- map(phys, ~ {
    df <- get_dups(.x)
    df$Genome_ID <- as.character(df$Genome_ID)
    df
}) |> 
    discard(is.null) |> 
    bind_rows(.id = 'dataset')
```

# Individual examples

## Example of double annotation

```{r}
taxa_double_annotation <- dups |> 
    filter(
        Duplicate_type == 'double_annotation', dataset == 'aerophilicity',
        Attribute_source == "Bergey's Manual", 
        Taxon_name == 'Streptobacillus'
    ) |> 
    pull(Taxon_name) |> 
    unique()

dups |> 
    filter(
        Taxon_name == sample(taxa_double_annotation, 1),
        Duplicate_type == 'double_annotation',
        dataset == 'aerophilicity'
    ) |> 
    DT::datatable(filter = 'top', options = list(scrollX = TRUE))
```

## Example of agreement

```{r}
taxa_agreements <- dups |> 
    filter(
        Duplicate_type == 'agreement', dataset == 'aerophilicity',
        Taxon_name == 'Campylobacter coli'
    ) |> 
    pull(Taxon_name) |> 
    unique()

dups |> 
    filter(
        Taxon_name == taxa_agreements[1], 
        Duplicate_type == 'agreement',
        dataset == 'aerophilicity'
    ) |> 
    DT::datatable(filter = 'top', options = list(scrollX = TRUE))
```

## Example of conflict

```{r}
taxa_conflicts <- dups |> 
    filter(
        Duplicate_type == 'conflict',
        dataset == 'aerophilicity'
    ) |> 
    pull(Taxon_name) |> 
    unique()

dups |> 
    filter(
        Taxon_name == 'Herminiimonas arsenicoxydans', 
        # Duplicate_type == 'conflict',
        dataset == 'aerophilicity'
    ) |> 
    DT::datatable(filter = 'top', options = list(scrollX = TRUE))
```





# Plot number of rows with diffrent types of duplicates

```{r}
dups_row_counts <- dups |> 
    count(dataset, Duplicate_type)

dups_row_counts |> 
    ggplot(aes(dataset, n)) + 
    geom_col(aes(fill = Duplicate_type)) +
    labs(
        title = 'Number of rows with different types of duplicates',
        subtitle = subtitle_msg
    ) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    )
```

# Plot proportions of rows with diffferent types of duplicates

```{r}
dups_row_counts |> 
    group_by(dataset) |> 
    mutate(prop = round(prop.table(n) * 100, digits = 2)) |> 
    ungroup() |> 
    ggplot(aes(dataset, prop)) + 
    geom_col(aes(fill = Duplicate_type)) +
    labs(
        title = 'Number of rows with different types of duplicates',
        subtitle = subtitle_msg
    ) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    ) + 
    scale_y_continuous(labels = scales::percent_format())
```

# Plot number of rows with conflicts

```{r}
dups_row_counts |>
    filter(Duplicate_type == 'conflict') |> 
    ggplot(aes(dataset, n)) +
    geom_col() +
    geom_label(aes(label = n)) +
    labs(
        title = 'Number of rows with conflicts per dataset',
        subtitle = subtitle_msg
    ) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    )
```

# Plot number of unique taxa with different types of duplicates

```{r}
dups_taxa_counts <- dups |> 
    select(dataset, Duplicate_type, Taxon_name) |> 
    distinct() |> 
    count(dataset, Duplicate_type)

dups_taxa_counts |> 
    ggplot(aes(dataset, n)) +
    geom_col(aes(fill = Duplicate_type)) +
    labs(
        title = 'Number of unique taxa with dupicates per dataset',
        subtitle = subtitle_msg
    ) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    )
```

# Plot proportions of unique taxa with duplicates per dataset

```{r}
dups_taxa_counts |> 
    group_by(dataset) |> 
    mutate(prop = round(prop.table(n) * 100, digits = 2)) |> 
    ungroup() |> 
    ggplot(aes(dataset, prop)) +
    geom_col(aes(fill = Duplicate_type)) +
    labs(
        title = 'Proportion of unique taxa per duplicate type per dataset',
        subtitle = subtitle_msg
    ) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    )

```

# Plot number of unique taxa with conflicts

```{r}
dups_taxa_counts |> 
    filter(Duplicate_type == 'conflict') |> 
    ggplot(aes(dataset, n)) +
    geom_col() +
    geom_label(aes(label = n)) +
    labs(
        title = 'Number of unique taxa with conflicts per dataset',
        subtitle = subtitle_msg
    ) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    )
```

# Resolved agreements (an example)

```{r}
resolved_agreements <- phys |> 
    map(resolve_agreements) |>
    map(~ {
        .x |> 
        mutate(
            Genome_ID = as.character(Genome_ID),
            Attribute_value = as.character(Attribute_value)
        )
    }) |> 
    discard(is.null) |> 
    bind_rows(.id = 'dataset')

resolved_agreements |> 
    filter(
        Taxon_name == taxa_agreements[1], dataset == 'aerophilicity'
    ) |> 
     DT::datatable(filter = 'top', options = list(scrollX = TRUE))
```


# Resolved conflicts

```{r, message=FALSE, warning=TRUE}
resolved_conflicts <- phys |> 
    map(~resolve_conflicts(.x)) |> 
    map(~ {
        .x |> 
            mutate(
                Genome_ID = as.character(Genome_ID),
                Attribute_value = as.character(Attribute_value)
            )
    }) |> 
    bind_rows(.id = 'dataset')
```


# An example of resolved conflict (compare above)

```{r}
resolved_conflicts |> 
    filter(
        Taxon_name == 'Herminiimonas arsenicoxydans',
        dataset == 'aerophilicity'
    ) |> 
    knitr::kable()
```

Remaining conflicts:

```{r}
resolved_conflicts <- map(phys, resolve_conflicts)
remaining_conflicts <- map(resolved_conflicts, get_conflicts) |> 
    discard(is.null)
remaining_conflicts$`growth temperature` |>
    nrow()
```

# Double annotations by source


```{r}
dups_source_counts <- dups |> 
    filter(Duplicate_type == 'double_annotation') |>
    count(dataset, Attribute_source) |> 
    mutate(
        Attribute_source = ifelse(
            grepl('http', Attribute_source), 'Madin', Attribute_source
        )
    )

dups_source_counts |> 
    ggplot(aes(dataset, n)) + 
    geom_col(aes(fill = Attribute_source)) + 
    labs(
        title = 'Counts of rows with double annotations per dataset per source'
    ) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    )
```



