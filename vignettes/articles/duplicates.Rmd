---
title: "Duplicates and conflicting annotations"
output:
    html_document:
        toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(taxPPro)
library(bugphyzz)
library(dplyr)
library(purrr)
library(ggplot2)
```

# Import data from bugphyzz

```{r, message=FALSE}
phys <- map(physiologies(), as_tibble)
```

# Get conflicts in attribute source

```{r, message=FALSE}
conflicts <- map(phys, get_conflicts) |> 
    discard(is.null)
```

# Plot number of rows with conflicts

```{r}
n_rows <- map_int(conflicts, nrow) |> 
    as.data.frame() |> 
    tibble::rownames_to_column('dataset') |> 
    as_tibble() |> 
    magrittr::set_colnames(c('dataset', 'n_rows'))

n_rows |> 
    ggplot(aes(dataset, n_rows)) + 
    geom_col() +
    geom_label(aes(label = n_rows)) +
    labs(
        title = 'Datasets with conflicting attribute sources',
    )
```

# Print table with conflicts

```{r}
bind_rows(conflicts, .id = 'dataset') |> 
    DT::datatable(filter = 'top', options = list(scrollX = TRUE))
```

# Resolve conflicts (only character/logical for now)

```{r, message=FALSE}
resolved <- map(phys, resolve_conflicts)
new_conflicts <- map(resolved, get_conflicts) |> 
    discard(is.null)
```

# Plot remaining number of rows with conflicts

Only "growth temperature" apppears because all conflicts have been solved or
dropped.

```{r}
n_rows_new <- map_int(new_conflicts, nrow) |> 
    as.data.frame() |> 
    tibble::rownames_to_column('dataset') |> 
    as_tibble() |> 
    magrittr::set_colnames(c('dataset', 'n_rows'))

n_rows_new |> 
    ggplot(aes(dataset, n_rows)) + 
    geom_col() +
    geom_label(aes(label = n_rows)) +
    labs(
        title = 'Datasets with remianing conflicting attribute sources'
    )
```

# Print table with the taxa that were resolved

Aerophilicity

```{r}
tax_names <- unique(conflicts$aerophilicity$Taxon_name)
resolved$aerophilicity |> 
    filter(Taxon_name %in% tax_names) |> 
    DT::datatable(filter = 'top', options = list(scrollX = TRUE))

```


Gram strain

```{r}
tax_names <- unique(conflicts$`gram stain`$Taxon_name)
resolved$`gram stain` |> 
    filter(Taxon_name %in% tax_names) |> 
    DT::datatable(filter = 'top', options = list(scrollX = TRUE))
```

Isolation site

```{r}
tax_names <- unique(conflicts$`isolation site`$Taxon_name)
resolved$`isolation site` |> 
    filter(Taxon_name %in% tax_names) |> 
    DT::datatable(filter = 'top', options = list(scrollX = TRUE))
```

Habitat
Only conflicts that were solved are displayed

```{r}
tax_names <- unique(conflicts$habitat$Taxon_name)
resolved$habitat |> 
    filter(Taxon_name %in% tax_names) |> 
    DT::datatable(filter = 'top', options = list(scrollX = TRUE))
```


# Print table of conflicts that were not resolved (in habitat)

```{r}
conflicting_tax_names <- unique(conflicts$habitat$Taxon_name)
resolved_tax_names <- resolved$habitat |> 
    filter(Taxon_name %in% tax_names) |> 
    pull(Taxon_name) |> 
    unique()
remaining_conflicting_tax_names <- 
    conflicting_tax_names[!conflicting_tax_names %in% resolved_tax_names]

conflicts$habitat |> 
    filter(Taxon_name %in% remaining_conflicting_tax_names) |> 
    DT::datatable(filter = 'top', options = list(scrollX = TRUE))

```













