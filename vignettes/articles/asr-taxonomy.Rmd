---
title: "ASR with a taxonomy tree"
subtitle: "All branch lengths are a unit"
output: 
    html_vignette:
        toc: yes
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message = FALSE}
library(taxPPro)
library(bugphyzz)
library(ete3r) # https://github.com/sdgamboa/ete3r
library(phytools)
library(ape)
library(dplyr)
library(tidytree)
library(ggtree)
library(tidyr)
```

# Attribute with categorical/logical values

## Import data

```{r}
select_cols <- c(
    "NCBI_ID", "Attribute", "Evidence", "Frequency", "Rank", 
    "Taxon_name"
)

oxygen <- physiologies("aerophilicity")[[1]] |> 
    resolve_agreements() |> 
    resolve_conflicts() |> 
    select(all_of(select_cols)) |> 
    filter(!is.na(NCBI_ID), !is.na(Rank))

glimpse(oxygen)
```

## Filter by rank

```{r}
oxygen_strain <- oxygen[oxygen$Rank == "strain",]
head(oxygen_strain)
```

## Get taxonomy tree for selected NCBI_IDs

```{r}
tree_ox_strain_data <- getTree(unique(oxygen_strain$NCBI_ID))
tree_ox_strain <- tree_ox_strain_data@phylo
tree_ox_strain
```

The metadata of the nodes is also present:

```{r}
my_tree_metadata <- tree_ox_strain_data %>% 
    as_tibble()
head(my_tree_metadata)
```

The tree must be rooted and fully solved (dicotomies only):

```{r}
is.rooted(tree_ox_strain)
```

```{r}
is.binary(tree_ox_strain)
```

# Step 4. Create a 1-0 matrix for each attribute (discrete)


```{r}
attribute_matrix <- oxygen_strain |> 
    mutate(Presence = 1) |> 
    select(NCBI_ID, Attribute, Presence) |> 
    pivot_wider(
        names_from = 'Attribute', values_from = 'Presence', values_fill = 0
    ) |> 
    distinct() |> 
    tibble::column_to_rownames(var = 'NCBI_ID') |> 
    as.data.frame() |> 
    as.matrix()
attribute_matrix[1:5, 1:5]
```

## Divide matrix into vectors

```{r}
states <- vector("list", ncol(attribute_matrix))
names(states) <- colnames(attribute_matrix)
for (i in seq_along(states)) {
    states[[i]] <- attribute_matrix[,i]
}
states <- states[vapply(states, \(y) sum(y) > 1, logical(1))]
states <- lapply(states, function(x) {
    output <- as.character(x)
    names(output) <- names(x)
    output
    })

states <- states[vapply(states, \(y) length(y) > 1 , logical(1))]
lapply(states, head)
```

# Estimate ASR and convert likelihoods in entries

These two steps are performed with a single function call:

```{r}
x <- createEntriesASR(x = states, phy = tree_ox_strain, df = my_tree_metadata)
head(x)
```

# Session info

```{r}
sessionInfo()
```

