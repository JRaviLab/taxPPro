---
title: "ASR with a taxonomy tree"
subtitle: "All branch lengths are a unit"
output: 
    html_document:
        toc: yes
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message = FALSE}
library(taxPPro)
library(bugphyzz)
library(ete3r) # https://github.com/sdgamboa/ete3r
library(phytools)
library(ape)
library(dplyr)
library(tidytree)
library(ggtree)
library(tidyr)
```

# Attribute with categorical/logical values

## Import data

```{r, message=FALSE, warning=FALSE}
aer <- as_tibble(physiologies('aerophilicity')[[1]]) |> 
    dplyr::filter(Attribute != '')
aer_pre <- pre_steps(aer)
```

Calculate new species

```{r}
aer_strains <- filter(aer_pre, Rank == 'strain')
aer_sp_asr <- calcParentScore(aer_strains) |> 
    dplyr::filter(Rank == 'species')
aer_new_sp <- aer_sp_asr[which(!aer_sp_asr$NCBI_ID %in% aer_pre$NCBI_ID),]
aer_ready <- bind_rows(aer_pre, aer_new_sp)
```

## Get taxonomy tree for selected NCBI_IDs

```{r}
aer_sp <- dplyr::filter(aer_ready, Rank == 'species')
aer_sp_tree_data <- getTree(unique(aer_sp$NCBI_ID))
aer_sp_tree <- aer_sp_tree_data@phylo
aer_sp_tree
```

The tree must be rooted and fully solved (dichotomies only):

```{r}
is.rooted(aer_sp_tree)
```

```{r}
is.binary(aer_sp_tree)
```


The metadata of the nodes is also present:

```{r}
my_tree_metadata <- aer_sp_tree_data %>% 
    as_tibble()
head(my_tree_metadata)
```

# Step 4. Create a 1-0 matrix for each attribute (discrete)

```{r}
attribute_matrix <- aer_sp |> 
    mutate(Presence = 1) |> 
    select(NCBI_ID, Attribute, Presence) |> 
    distinct() |> 
    pivot_wider(
        names_from = 'Attribute', values_from = 'Presence', values_fill = 0
    ) |> 
    distinct() |> 
    tibble::column_to_rownames(var = 'NCBI_ID') |> 
    as.data.frame() |> 
    as.matrix()
attribute_matrix[1:5, 1:5]
```

## Divide matrix into vectors

```{r}
states <- vector("list", ncol(attribute_matrix))
names(states) <- colnames(attribute_matrix)
for (i in seq_along(states)) {
    states[[i]] <- attribute_matrix[,i]
}
states <- states[vapply(states, \(y) sum(y) > 1, logical(1))]
states <- lapply(states, function(x) {
    output <- as.character(x)
    names(output) <- names(x)
    output
    })

states <- states[vapply(states, \(y) length(y) > 1 , logical(1))]
lapply(states, head)
```

# Estimate ASR and convert likelihoods in entries

These two steps are performed with a single function call:

```{r}
states$aerobic[1] <- NA
x <- createEntriesASR(x = states, phy = aer_sp_tree, df = my_tree_metadata)
rownames(x) <- NULL
x <- as_tibble(x)
head(x)
```

```{r}
genera <- x[which(x$Rank == 'genus'), 'NCBI_ID', drop = TRUE]
new_genera <- x[which(!x$NCBI_ID %in% aer_ready$NCBI_ID),]

new_genera$NCBI_ID <- as.character(new_genera$NCBI_ID)
final <- bind_rows(new_genera, aer_ready)
```

## Add children

```{r}
final_inh <- downstream(final)
```
```{r}
final_inh
```

```{r}
final_inh_2 <- final_inh |> 
    filter(Rank %in% c('genus', 'species', 'strain'))
```


```{r}
aer_propagate <- propagate(aer)
```



```{r}
aer$NCBI_ID <- as.character(aer$NCBI_ID)
aer$Parent_NCBI_ID <- as.character(aer$Parent_NCBI_ID)
data <- list(
    original = aer,
    `original + majority vote` = aer_propagate,
    `original + ace-tax-tree` = final_inh_2
) |> 
    bind_rows(.id = 'method') |> 
    distinct()
```



```{r}
summary <- data |> 
    count(method, Attribute, Evidence, Rank) |> 
    filter(Rank %in% c('genus', 'species', 'strain'))
```

```{r}
summary |> 
    ggplot(aes(Attribute, n)) +
    geom_col(aes(fill = Evidence)) +
    facet_grid(method~Rank, scales = "free_x") + 
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    )
```

```{r}
summary |> 
    filter(grepl('asr', Evidence)) |> 
    ggplot(aes(Attribute, n)) +
    geom_col(aes(fill = Evidence)) +
    facet_grid(method~Rank, scales = "free_x") + 
    labs(
        title = 'Comparison of ASR methods 
        ape::ace +majority vote (top) vs majority-vote (bottom)',
        subtitle = 'asr = mv + ape::ace; asr-tax = mv',
        y = '# annotation'
    ) +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    )
```






# Session info

```{r}
sessionInfo()
```

