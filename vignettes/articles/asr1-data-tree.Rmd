---
title: "Propagation with data.tree"
output:
  html_document:
    toc:
      true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(taxPPro)
library(bugphyzz)
library(data.tree)
library(dplyr)
library(purrr)
```

# Get bacteria taxonmy from the NCBI

```{r, message=FALSE}
b_tbl <- getNCBI(format = 'table')
b_tree <- as.Node(b_tbl[, 'pathString', drop = FALSE], pathDelimiter = '|||')
```

# Bugphyzz

```{r divide into attributes, message=FALSE, warning=FALSE}
aer <- physiologies(
  'aerophilicity', remove_false = TRUE, full_source = FALSE
)[[1]]
aer <- preSteps(aer, tax.id.type = 'NCBI_ID', remove_false = TRUE)
dic <- c('g__', 's__', 't__')
names(dic) <- c('genus', 'species', 'strain')
aer$NCBI_ID <- paste0(dic[aer$Rank], aer$NCBI_ID)
select_cols <- c(
  'NCBI_ID', 'Attribute', 'Evidence', 'Attribute_source', 'Score'
)
aer <- unique(aer[, select_cols])
aer <- aer[which(grepl('^[gs]__', aer$NCBI_ID)),]
```

# Propagation

Add attributes

```{r}
res <- addAttributes(data_tree = b_tree, df = aer)
```

Print tree

```{r}
print(
    # res$p__57723$c__204432$o__204433$f__204434,
    # res$p__1224$c__1236$o__91347$f__543,
    res$p__1224$c__1236$o__91347$f__543$g__561,
    'aerobic__Score', 'aerobic__Evidence',
    'facultatively_anaerobic__Score', 'facultatively_anaerobic__Evidence',
    'anaerobic__Score', 'anaerobic__Evidence',
    'microaerophilic__Score', 'microaerophilic__Evidence',
    'obligately_aerobic__Score', 'obligately_aerobic__Evidence',
    'obligately_anaerobic__Score', 'obligately_anaerobic__Evidence',
    limit = 100
)
```

Propagate

```{r}
res$Do(asrUpstream, traversal = 'post-order')
res$Do(inhDownstream, traversal = 'pre-order')
```

Print propagated tree

```{r}
print(
    # res$p__57723$c__204432$o__204433$f__204434,
    # res$p__1224$c__1236$o__91347$f__543,
    res$p__1224$c__1236$o__91347$f__543$g__561,
    'aerobic__Score', 'aerobic__Evidence',
    'facultatively_anaerobic__Score', 'facultatively_anaerobic__Evidence',
    'anaerobic__Score', 'anaerobic__Evidence',
    'microaerophilic__Score', 'microaerophilic__Evidence',
    'obligately_aerobic__Score', 'obligately_aerobic__Evidence',
    'obligately_anaerobic__Score', 'obligately_anaerobic__Evidence',
    limit = 100
)
```

# Session infomation

```{r}
sessioninfo::session_info()
```
