
---
title: "Propagation with data.tree"
output:
  html_document:
    toc:
      true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(taxPPro)
library(bugphyzz)
library(data.tree)
library(dplyr)
```

# Get NCBI data

```{r, message=FALSE}
bac_tree <- getNCBI(format = 'tree')
```


Convert to data.tree

# Bugphyzz

```{r divide into attributes, message=FALSE, warning=FALSE}
aer <- physiologies('aerophilicity', remove_false = TRUE)[[1]]
aer <- preSteps(aer, tax.id.type = 'NCBI_ID', remove_false = TRUE)
dic <- c('g__', 's__', 't__')
names(dic) <- c('genus', 'species', 'strain')
aer$NCBI_ID <- paste0(dic[aer$Rank], aer$NCBI_ID)
select_cols <- c(
  'NCBI_ID', 'Attribute', 'Attribute_value', 'Evidence',  'Frequency', 
  'Confidence_in_curation', 'Attribute_source', 'Score'
)
aer <- unique(aer[, select_cols])
aer <- aer[which(grepl('^[gs]__', aer$NCBI_ID)),]
```

## Add Attribute values

```{r}
a <- split(aer, factor(aer$Attribute))
for (i in seq_along(a)) {
  attr_name <- names(a)[i]
  lst_vct <- split(a[[i]], factor(a[[i]][['NCBI_ID']]))
  bac_tree$Do(function(node) node[[attr_name]] <- lst_vct[[node$name]]$Score)
}
```

## Propagate upstream

```{r}
bac_tree$Do(function(node) node$aerobic <- Aggregate(node, 'aerobic', function(x) sum(x[!is.na(x)])), traversal = 'post-order')
bac_tree$Do(function(node) node$`facultatively anaerobic` <- Aggregate(node, 'facultatively anaerobic', function(x) sum(x[!is.na(x)])), traversal = 'post-order')
bac_tree$Do(function(node) node$anaerobic <- Aggregate(node, 'anaerobic', function(x) sum(x[!is.na(x)])), traversal = 'post-order')


```

## Propagate downstream

```{r}
bac_tree$Do(function(node) if (is.na(node$aerobic)) { node$aerobic <- node$parent$aerobic})
bac_tree$Do(function(node) if (is.na(node$`facultatively anaerobic`)) { node$`facultatively anaerobic` <- node$parent$`facultatively anaerobic`})
bac_tree$Do(function(node) if (is.na(node$anaerobic)) { node$anaerobic <- node$parent$anerobic})
```

## Convert back to tree

```{r}
tbl <- ToDataFrameTree(bac_tree, 'aerobic', 'facultatively anaerobic', 'anaerobic')
m <- tbl |>
  tibble::column_to_rownames('levelName') |>
  as.matrix()

rownames(m) <- sub('^.*([kpcofgst]__[0-9]+).*$', '\\1', rownames(m))
m2 <- t(apply(t(m), 2, function(x) x / sum(x)))

m2[is.na(m2)] <- 0

m3 <- m2[rowSums(m2) > 0.001,]

```

# Session infomation
```{r}
sessioninfo::session_info()
```
