---
title: "Propagation with data.tree"
output:
  html_document:
    toc:
      true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(taxPPro)
library(bugphyzz)
library(data.tree)
library(dplyr)
library(purrr)
```

# Get bacteria taxonmy from the NCBI

```{r, message=FALSE}
b_tbl <- getNCBI(format = 'table')
b_tree <- as.Node(b_tbl[, 'pathString', drop = FALSE], pathDelimiter = '|||')
```

# Bugphyzz

```{r divide into attributes, message=FALSE, warning=FALSE}
aer <- physiologies(
  'aerophilicity', remove_false = TRUE, full_source = FALSE
)[[1]]
aer <- preSteps(aer, tax.id.type = 'NCBI_ID', remove_false = TRUE)
dic <- c('g__', 's__', 't__')
names(dic) <- c('genus', 'species', 'strain')
aer$NCBI_ID <- paste0(dic[aer$Rank], aer$NCBI_ID)
select_cols <- c(
  'NCBI_ID', 'Attribute', 'Evidence', 'Attribute_source', 'Score'
)
aer <- unique(aer[, select_cols])
aer <- aer[which(grepl('^[gs]__', aer$NCBI_ID)),]
```

```{r}
res <- addAttributes(data_tree = b_tree, df = aer)
```



```{r}
jj <- res$p__1224$c__1236$o__91347$f__543$g__561
jj$aerobic__Score <- NA


attrs <- unique(res$attributesAll)
output <- vector('double', length(attrs))
for (i in seq_along(output)) {
  output[[i]] <- jj$Get(attribute = attrs[i])
}
names(output) <- attrs
output[is.na(output)] <- 0
x <- output / sum(output)

for (i in seq_along(x)) {
  jj[[attrs[i]]] <- x[i]
}

```


```{r}
print(
  res$p__1224$c__1236$o__91347$f__543$g__561,
  'aerobic__Score', 'facultatively_anaerobic__Score'
)
```



```{r}
jjj <- c('aerobic__Score', 'facultatively_anaerobic__Score')
res$p__1224$c__1236$o__91347$f__543$g__561$children

m <- res$p__1224$c__1236$o__91347$f__543

sdf <- data.frame(x = letters[1:5], y = 1:5)

m$g__561$s__562$my_attr <- sdf
m$g__561$s__1499973$my_attr <- sdf

x <- m$g__561$s__562$Get('my_attr')


m$g__561$s__562$Get('my_attr', simplify = FALSE)
m$g__561$s__562$Do()

```
## Propagate upstream

```{r}
bac_tree$Do(function(node) node$aerobic <- Aggregate(node, 'aerobic', function(x) sum(x[!is.na(x)])), traversal = 'post-order')
bac_tree$Do(function(node) node$`facultatively anaerobic` <- Aggregate(node, 'facultatively anaerobic', function(x) sum(x[!is.na(x)])), traversal = 'post-order')
bac_tree$Do(function(node) node$anaerobic <- Aggregate(node, 'anaerobic', function(x) sum(x[!is.na(x)])), traversal = 'post-order')
```

## Propagate downstream

```{r}
bac_tree$Do(function(node) if (is.na(node$aerobic)) { node$aerobic <- node$parent$aerobic})
bac_tree$Do(function(node) if (is.na(node$`facultatively anaerobic`)) { node$`facultatively anaerobic` <- node$parent$`facultatively anaerobic`})
bac_tree$Do(function(node) if (is.na(node$anaerobic)) { node$anaerobic <- node$parent$anerobic})
```

## Convert back to tree

```{r}
tbl <- ToDataFrameTree(bac_tree, 'aerobic', 'facultatively anaerobic', 'anaerobic')
m <- tbl |>
  tibble::column_to_rownames('levelName') |>
  as.matrix()

rownames(m) <- sub('^.*([kpcofgst]__[0-9]+).*$', '\\1', rownames(m))
m2 <- t(apply(t(m), 2, function(x) x / sum(x)))

m2[is.na(m2)] <- 0

m3 <- m2[rowSums(m2) > 0.001,]

```

# Session infomation
```{r}
sessioninfo::session_info()
```
