---
title: "Propagation workflow"
output:
    html_document:
        toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE
)
```

```{r setup, message=FALSE}
library(taxPPro)
library(bugphyzz)
library(data.tree)
library(dplyr)
library(purrr)
```

# Import bugphyzz data

Below, we need to normalize the score so that the total score of all
attributes per taxon is equal to 1:

```{r import bugphyzz data, message=FALSE}
phys <- physiologies('aerophilicity', remove_false = TRUE, full_source = FALSE)[[1]] |>
  prepareDatForPropagation() |>
  group_by(NCBI_ID) |>
  mutate(Score = Score / sum(Score)) |> # Normalize scores
  ungroup() |> 
  distinct()
```

# Create input table

```{r}
input_tbl <- phys |>
  select(NCBI_ID, Attribute, Score, Evidence) |>
  distinct() |> 
  tidyr::complete(
    ## Note that Evidence is empty, not NA
    NCBI_ID, Attribute, fill = list(Score = 0, Evidence = '')
)
```

# Import tree from taxPPro package

```{r}
data("tree_list")
tree <- as.Node(tree_list)
```

# Map bugphyzz annotations to the nodes in the tree

```{r tree mapping}
l <- split(input_tbl, factor(input_tbl$NCBI_ID))
tree$Do(function(node) {
    if (!is.null(l[[node$name]])) {
        node[['table']] <- l[[node$name]]
    }
})
```

```{r, include=FALSE, echo=FALSE, eval=FALSE}
tree$d__2$p__1224$c__1236$o__91347$f__543$g__561$s__562$table
tree$d__2$p__1224$c__1236$o__91347$f__543$g__561$table <- l[['g__561']]
tree$d__2$p__1224$c__1236$o__91347$f__543$g__561$table
tree$d__2$p__1224$c__1236$o__91347$f__543$g__561$table <- NULL
tree$d__2$p__1224$c__1236$o__91347$f__543$g__561$s__1182732$table
```

# Propagate annotations

```{r propagation}
tree$Do(asr, traversal = 'post-order')
tree$Do(inh, traversal = 'pre-order')
```

# Export table

```{r}
data_tree_tbl <- tree$Get(function(node) node[['table']], simplify = FALSE) |>
    purrr::discard(~ all(is.na(.x))) |>
    dplyr::bind_rows() |> 
    relocate(NCBI_ID) 
# write.table(x = data_tree_tbl, file = 'export_test.tsv', sep = '\t', row.names = FALSE)
```




```{r}
attrs <- unique(phys$Attribute)
all_node_names <- tree$Get(function(node) node$name, simplify = FALSE) |> 
  unlist(recursive = TRUE, use.names = FALSE) |> 
  unique()
all_node_names <- all_node_names[which(!all_node_names %in% unique(table$NCBI_ID))]
empty_df <- data.frame(
  NCBI_ID = sort(rep(all_node_names, length(attrs))), 
  Attribute = rep(attrs, length(all_node_names)), 
  Score = 0,
  Evidence = NA
)
```



```{r}
inferred_values <- bind_rows(table, empty_df)
other_ids <- phys$NCBI_ID[which(!phys$NCBI_ID %in% inferred_values$NCBI_ID)]
other_ids <- unique(other_ids)
other_phys <- filter(phys, NCBI_ID %in% other_ids)

real_final_table <- bind_rows(inferred_values, other_phys)

```




Taxa that sum 0 for all attributes didn't have any prediction at all.
Taxa that sum 1, but had some attributes 0 are Negatives.

```{r}
table |> group_by(NCBI_ID) |> summarise(score = sum(Score))
```


# Clean the tree

```{r}
tree$Do(function(node) {
    node[['table']] <- NULL
})
```

# Session information

```{r}
sessioninfo::session_info()
```

